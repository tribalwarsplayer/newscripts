let link=["https://"+window.location.host+"/game.php?village=","&screen=place&mode=scavenge"];async function loadCheese(){console.log("load cheese"),window.TwCheese&&TwCheese.tryUseTool("ASS")||$.ajax("https://cheesasaurus.github.io/twcheese/launch/ASS.js?"+~~(new Date/3e5),{cache:1},dataType:"script"),await new Promise(e=>setTimeout(e,3e3))}function getCookie(e){for(var t=e+"=",o=decodeURIComponent(document.cookie).split(";"),n=0;n<o.length;n++){for(var i=o[n];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""}async function run(){console.log("run");let e=$(".btn.btn-default.free_send_button"),t=document.getElementsByClassName("return-countdown").length;if(console.log("Ongoing: "+t),!t){await new Promise(e=>setTimeout(e,500));for(let t=e.length-1;t>-1;--t){await new Promise(e=>setTimeout(e,250));try{window.TwCheese.useTool("ASS").prepareBestOption()}catch{console.log("Prepared")}await new Promise(e=>setTimeout(e,250)),e.eq(t).trigger("click"),console.log("Click")}}await new Promise(e=>setTimeout(e,250)),await getNextVillage(),console.log("wait 5s"),await new Promise(e=>setTimeout(e,5e3))}async function getNextVillage(){let e=link[0]+"n"+window.top.game_data.village.id+link[1];console.log("get "+e),window.top.$.ajax({type:"GET",url:e,dataType:"html",success:function(e){let t=window.top.$(e),o=/<\s*title\s*>([^<]+)<\/title\s*>/g.exec(e)[1],n=window.top.$.parseJSON(e.split("TribalWars.updateGameData(")[1].split(");")[0]);window.top.game_data=n,window.top.$("#header_info").html(window.top.$("#header_info",t).html()),window.top.$("#topContainer").html(window.top.$("#topContainer",t).html()),window.top.$("#contentContainer").html(window.top.$("#contentContainer",t).html()),window.top.$("#quickbar_inner").html(window.top.$("#quickbar_inner",t).html()),window.top.$("head").find("title").html(o)}})}async function scavenge(){for(await loadCheese();;){let e=getCookie("mode");if("scavenging"!=e){if(""!=e){console.log("thread is inactive..."),await new Promise(e=>setTimeout(e,12e4));continue}document.cookie="mode=scavenging"}else{let e=parseInt(window.game_data.player.villages),t=0;for(;t<e;)++t,await run();document.cookie="mode=lae",console.log("wait 10 min"),await new Promise(e=>setTimeout(e,6e5)),window.partialReload(),console.log("wait 5s"),await new Promise(e=>setTimeout(e,5e3))}}}scavenge();
